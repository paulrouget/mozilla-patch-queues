# vim: se ft=diff :
# HG changeset patch
# User Sonny Piers <sonny.piers@gmail.com>
# Date 1332437264 -3600
Bug 612252 - "clear console" needs a keyboard shortcut in a bad way

# HG changeset patch
# User Sonny Piers <sonny.piers@gmail.com>
# Date 1332437264 -3600
# Node ID a97089db8bf45a4360c7f8284d5d1ef299761c61
# Parent  5c13fce74f83f7328c01f266f1e6d372d40af0fa
Bug 612252 - "clear console" needs a keyboard shortcut in a bad way

diff -r 5c13fce74f83 -r a97089db8bf4 browser/devtools/webconsole/HUDService.jsm
--- a/browser/devtools/webconsole/HUDService.jsm	Thu Mar 22 08:36:36 2012 +0000
+++ b/browser/devtools/webconsole/HUDService.jsm	Thu Mar 22 18:27:44 2012 +0100
@@ -3750,8 +3750,8 @@
     outerWrap.setAttribute("class", "hud-outer-wrapper");
     outerWrap.setAttribute("flex", "1");
 
-    let consoleCommandSet = this.makeXULNode("commandset");
-    outerWrap.appendChild(consoleCommandSet);
+    let consoleKeySet = outerWrap.appendChild(this.makeXULNode("keyset"));
+    this.makeClearConsoleKey(consoleKeySet);
 
     let consoleWrap = this.makeXULNode("vbox");
     this.consoleWrap = consoleWrap;
@@ -4116,26 +4116,37 @@
    */
   makeClearConsoleButton: function HUD_makeClearConsoleButton(aToolbar)
   {
-    let hudId = this.hudId;
-    function HUD_clearButton_onCommand() {
-      let hud = HUDService.getHudReferenceById(hudId);
-      if (hud.jsterm) {
-        hud.jsterm.clearOutput(true);
-      }
-      if (hud.gcliterm) {
-        hud.gcliterm.clearOutput();
-      }
-    }
-
     let clearButton = this.makeXULNode("toolbarbutton");
     clearButton.setAttribute("label", this.getStr("btnClear"));
+    clearButton.setAttribute("hudId", this.hudId);
+    clearButton.setAttribute("buttonType", "clearConsole");
     clearButton.classList.add("webconsole-clear-console-button");
-    clearButton.addEventListener("command", HUD_clearButton_onCommand, false);
+    clearButton.setAttribute("oncommand", "HUDConsoleUI.command(this);");
 
     aToolbar.appendChild(clearButton);
   },
 
   /**
+   * Creates and attaches the XUL keyset element, which handles the keyboard
+   * shortcuts for this Web Console.
+   *
+   * @returns void
+   */
+  makeClearConsoleKey: function HUD_makeClearConsoleKey(aKeySet)
+  {
+    const CLEAR_CONSOLE = "clearConsoleCmd.commandkey";
+
+    let clearConsoleKey = this.makeXULNode("key");
+    clearConsoleKey.setAttribute("buttonType", "clearConsole");
+    clearConsoleKey.setAttribute("hudId", this.hudId);
+    clearConsoleKey.setAttribute("key", stringBundle.GetStringFromName(CLEAR_CONSOLE));
+    clearConsoleKey.setAttribute("modifiers", "accel shift");
+    clearConsoleKey.setAttribute("oncommand", "HUDConsoleUI.command(this);");
+
+    aKeySet.appendChild(clearConsoleKey);
+  },
+
+  /**
    * Destroy the property inspector message node. This performs the necessary
    * cleanup for the tree widget and removes it from the DOM.
    *
@@ -6463,6 +6474,15 @@
         HUDService.copySelectedItems(outputNode);
         break;
       }
+      case "clearConsole":
+        let hud = HUDService.hudReferences[hudId];
+        if (hud.jsterm) {
+          hud.jsterm.clearOutput(true);
+        }
+        if (hud.gcliterm) {
+          hud.gcliterm.clearOutput();
+        }
+        break;
       case "selectAll": {
         HUDService.hudReferences[hudId].outputNode.selectAll();
         break;
diff -r 5c13fce74f83 -r a97089db8bf4 browser/devtools/webconsole/test/Makefile.in
--- a/browser/devtools/webconsole/test/Makefile.in	Thu Mar 22 08:36:36 2012 +0000
+++ b/browser/devtools/webconsole/test/Makefile.in	Thu Mar 22 18:27:44 2012 +0100
@@ -156,6 +156,7 @@
 	browser_cached_messages.js \
 	browser_gcli_break.js \
 	head.js \
+	browser_webconsole_bug_612252_clear_console_shortcut.js \
 	$(NULL)
 
 _BROWSER_TEST_PAGES = \
diff -r 5c13fce74f83 -r a97089db8bf4 browser/devtools/webconsole/test/browser_webconsole_bug_612252_clear_console_shortcut.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/browser/devtools/webconsole/test/browser_webconsole_bug_612252_clear_console_shortcut.js	Thu Mar 22 18:27:44 2012 +0100
@@ -0,0 +1,45 @@
+/* Any copyright is dedicated to the Public Domain.
+   http://creativecommons.org/publicdomain/zero/1.0/ */
+
+const TEST_URI = "http://example.com/";
+
+const HUD_STRINGS_URI = "chrome://browser/locale/devtools/webconsole.properties";
+const CLEAR_CONSOLE = "clearConsoleCmd.commandkey";
+
+// Tests that the keyboard shortcut to clear the console function.
+
+function test() {
+  addTab(TEST_URI);
+  browser.addEventListener("DOMContentLoaded", testKeyboardShortcuts, false);
+}
+
+function testKeyboardShortcuts() {
+  browser.removeEventListener("DOMContentLoaded", testKeyboardShortcuts,
+                              false);
+
+  openConsole();
+
+  let hudId = HUDService.getHudIdByWindow(content);
+  let hud = HUDService.hudReferences[hudId];
+  let jsterm = hud.jsterm;
+  ok(jsterm, "we have the JavaScript terminal");
+
+  ok(false);
+
+  jsterm.execute("true;");
+
+  let nodes = jsterm.outputNode.querySelectorAll(".hud-msg-node");
+  ok(nodes.length > 0, "there is some output");
+
+  let stringBundle = Services.strings.createBundle(HUD_STRINGS_URI);
+  ok(stringBundle, "we have the string bundle");
+  let clearKey = stringBundle.GetStringFromName(CLEAR_CONSOLE);
+  EventUtils.synthesizeKey(clearKey, { accelKey: true, shiftKey: true });
+
+  nodes = jsterm.outputNode.querySelectorAll(".hud-msg-node");
+  is(nodes.length, 0, "pressing the keyboard shortcut to clear the " +
+     "console did so");
+
+  closeConsole();
+  finishTest();
+}
diff -r 5c13fce74f83 -r a97089db8bf4 browser/locales/en-US/chrome/browser/devtools/webconsole.properties
--- a/browser/locales/en-US/chrome/browser/devtools/webconsole.properties	Thu Mar 22 08:36:36 2012 +0000
+++ b/browser/locales/en-US/chrome/browser/devtools/webconsole.properties	Thu Mar 22 18:27:44 2012 +0100
@@ -48,7 +48,7 @@
 tipGlobal=Toggle Global Message logging
 localConsole=Local Console
 clearConsoleCmd.label=Clear Console
-clearConsoleCmd.accesskey=e
+clearConsoleCmd.commandkey=C
 # LOCALIZATION NOTE (btnClear):
 #
 # This is used as the text of the "Clear" button for the toolbar. It clears the

